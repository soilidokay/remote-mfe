{"version":3,"file":"DynamicLoader.js","sources":["../src/DynamicLoader.ts"],"sourcesContent":["import { CreateActionSingle, getWindowHandler } from \"./Helper\";\r\n\r\ninterface IProxy {\r\n    get: (request: string) => any;\r\n    init: () => any;\r\n}\r\ninterface RemoteConfig {\r\n    [remoteName: string]: string;\r\n}\r\nconst GWindow = window as any\r\nconst remoteContainer: Record<string, IProxy> = getWindowHandler('z_rtctn')\r\n\r\nconst setRemoteLink = (remoteName: string, module: IProxy) => {\r\n    const remotes = remoteContainer;\r\n    remotes[remoteName] = module;\r\n};\r\n\r\nconst loadScripts = (module: string, remoteUrl: string): Promise<IProxy> => {\r\n    if (remoteContainer[module]) {\r\n        return Promise.resolve(remoteContainer[module]);\r\n    }\r\n    return new Promise((resolve, reject) => {\r\n        // This part depends on how you plan on hosting and versioning your federated modules\r\n        const script = document.createElement(\"script\");\r\n        script.onerror = () => {\r\n            document.head.removeChild(script);\r\n            reject(\"loading \" + remoteUrl + \" failed!\");\r\n        };\r\n        script.async = false;\r\n        script.src = remoteUrl + \"?v=\" + new Date().getTime();\r\n        script.onload = () => {\r\n            // the injected script has loaded and is available on window\r\n            // we can now resolve this Promise\r\n            const proxy = {\r\n                get: (request: string) => GWindow[module].get(request),\r\n                init: () => {\r\n                    try {\r\n                        const args = getWebpaclArgShareSingleton()\r\n                        if (!args.data) {\r\n                            args.data = []\r\n                        } else if (!Array.isArray(args.data)) {\r\n                            args.data = [args.data]\r\n                        }\r\n                        const res = GWindow[module].init(...args.data);\r\n                        return res\r\n                    } catch (e) {\r\n                        console.log(\"remote container already initialized\");\r\n                    }\r\n                },\r\n            };\r\n            setRemoteLink(module, GWindow[module]);\r\n            resolve(proxy);\r\n        };\r\n        // inject this script with the src set to the versioned remoteEntry.js\r\n        document.head.appendChild(script);\r\n    });\r\n};\r\n\r\nexport async function dynamicImport<T = any>(modulePath: string, remoteUrl: string): Promise<T> {\r\n    const [remoteName, module] = modulePath.split(\"/\");\r\n    const container = await loadScripts(remoteName, remoteUrl);\r\n    await container.init()\r\n    const factory = await container.get(`./${module}`);\r\n    return factory() as T;\r\n}\r\n\r\nconst webpackShared = {} as any\r\nconst getWebpaclArgShare = () => {\r\n    return webpackShared\r\n}\r\nexport const getWebpaclArgShareSingleton = CreateActionSingle('_zzd1', getWebpaclArgShare)\r\n\r\nconst setWebpaclArgShare = (data: any) => {\r\n    webpackShared.data = data\r\n}\r\nexport const setWebpaclArgShareSingleton = CreateActionSingle('_zzd2', setWebpaclArgShare);\r\n(window as any).setWebpaclArgShareSingleton = setWebpaclArgShareSingleton\r\n\r\n// export const InitialArgShare = () => {\r\n//     import(\"InitialArgShare\" as any)\r\n//     return \"InitialArgShare\"\r\n// }"],"names":[],"mappings":"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"}